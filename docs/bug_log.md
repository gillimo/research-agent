Bug Log
=======

- 2025-12-30: UAT harness duplicated output in socket mode because stdout + socket streams were both captured; disabled stdout capture when socket mode is active.
- 2025-12-30: ANSI prompt auto-wait was untested; added a harness test to cover ANSI prompt stripping and prompt regex matching.
- 2025-12-30: Mailbox mode needed to avoid blocking waits and exit after a short window; harness now skips waits and auto-quits after `mailbox_duration`.
- 2025-12-30: Test socket mode skipped context auto-surface and initial context harvest, creating behavior differences; removed the test-only bypass so behavior matches real sessions.
- 2025-12-30: UAT harness could only wait on text output, making socket tests brittle; added event-based waits (`wait_for_event`) to align with prompt/input events.
- 2025-12-30: UAT socket scenarios sent inputs before loop readiness, causing racey runs; updated scenarios to wait for `loop_ready`/`prompt` events.
- 2025-12-30: Test socket parity lacked a context-summary assertion; added a scenario wait for `martin: Context:` in socket UAT.
- 2025-12-30: UAT runs lacked a unified event trace outside mailbox mode; added optional `event_log` NDJSON output for any run.
- 2025-12-30: Socket UAT scenarios did not specify `event_log`, leaving some runs without a consistent audit trail; added `event_log` to default scenarios.
- 2025-12-30: UAT runs lacked step-level output snapshots for quick UX review; added optional `screenshot_dir` snapshots to the harness and scenarios.
- 2025-12-30: Socket UAT still misses `loop_ready` and `martin: Context:` in some runs; harness timing shows input timeouts before readiness events.
- 2025-12-30: Socket harness could miss output events; added stdout fallback capture and replay of `loop_ready`/`input_wait` on connect.
- 2025-12-30: Socket reader timed out after connect (1s timeout), dropping output events; set socket to blocking mode after connect.
- 2025-12-30: Socket UAT loop_ready/prompt waits were too short for slow startups; increased scenario timeouts to 30s.
- 2025-12-30: Socket UAT input acks were missing because inputs were sent on short-lived connections; switched to sending on the persistent socket connection.
- 2025-12-30: Socket input wait used a shared threading.Event and occasionally missed `input_used`; switched to event-buffer waits for `input_used`.
- 2025-12-30: Harness warned about loop readiness even when scenarios explicitly waited on `loop_ready`; suppress redundant warning when scenarios include the wait.
- 2025-12-30: Socket UAT scenario sent follow-up input during approval prompt; reordered steps to answer approval before next question.
- 2025-12-30: Socket runs sometimes miss the `input_used` wait despite matching input events; added fallback to accept matching input_ack/input_used in the event buffer.
- 2025-12-30: Socket UAT scenario sent follow-up question during diagnosis prompts; added wait for plan completion before asking next question.
- 2025-12-30: Socket UAT scenario did not respond to outside-workspace confirmation prompt; added explicit wait + response.
- 2025-12-30: Socket UAT scenario asked a follow-up question but did not respond to the subsequent approval prompt; added approval response.
- 2025-12-30: Socket UAT follow-up waits were too short when Librarian connection retries delayed prompts; increased follow-up wait timeouts.
- 2025-12-30: Follow-up approval prompt can be conditional; added `input_when_text` to send responses only when prompts appear.
- 2025-12-30: Event log duplicated socket output entries (raw + cleaned); suppress duplicate logging in the harness.
- 2025-12-30: Mailbox runs sent approval responses too early when waits were skipped; added `input_when_text` gating for approval prompts.
- 2025-12-30: Mailbox mode skips conditional inputs because conditions are checked immediately and not retried; needs deferred input queue.
- 2025-12-30: Added deferred input queue so mailbox mode can send conditional inputs once prompts appear.
- 2025-12-30: Mailbox duration was too short for prompts to appear; extended mailbox scenario duration to 20s.
- 2025-12-30: Mailbox scenario sent follow-up too early; gated follow-up on "Done. OK" and increased duration to 40s.
- 2025-12-30: Scenario mailbox_duration was ignored (CLI default always used); apply scenario override when flag not set.
- 2025-12-30: Conditional inputs matched old output because checks used full buffer; track output/event cursors for deferred inputs.
- 2025-12-30: Mailbox mode still sent conditional inputs early because immediate checks matched old output; always defer conditional inputs in mailbox mode.
- 2025-12-30: Conditional inputs needed prompt-aware matching; checks now consider prompt event text for `input_when_text`.
- 2025-12-30: Multiple conditional inputs with the same token could trigger at the first prompt; added baseline/consumed counters to pace repeated prompts.
- 2025-12-30: Prompt token counts double-counted output and prompt events; prefer prompt events when available to avoid duplicate fires.
- 2025-12-30: Prompt-aware matching skipped non-prompt tokens like "Done. OK"; fall back to output buffer when prompt texts donâ€™t match.
- 2025-12-30: Mailbox runs could exit with unsent pending inputs without any trace; log pending inputs in the event log for review.
- 2025-12-30: Conditional approvals could fire on stale prompts because immediate sends didn't consume prompt counters; track consumption on immediate sends and log pending sends.
- 2025-12-30: Immediate conditional sends could queue forever when prompt already present; use latest prompt/output checks in non-mailbox mode.
- 2025-12-29: Unix path redaction regex used `[^\\s]` and left trailing characters; fixed to use `[^\\s]` with proper `\\s` handling.
- 2025-12-29: Librarian chunking tests hung due to heavy FAISS/embedding load; added `RESEARCHER_FORCE_SIMPLE_INDEX` to force SimpleIndex in tests.
- 2025-12-30: Librarian ingest hit `SimpleIndex.save()` missing `path` (from ledger: librarian_error). Fixed by saving via config-aware helper.
- 2025-12-30: Chat auto-ingest crashed due to missing `re` import in `researcher/cli.py`; added import.
- 2025-12-30: CLI crashes were not captured in `logs/outputs` when an unhandled exception occurred; added top-level crash logging to write a `_crash.log`.
- 2025-12-30: `pytest` not found when running tests in repo; mitigated by `python -m pytest -q` and `/verify` guidance.
- 2025-12-30: `.venv` is missing (`.venv\\Scripts\\python.exe` not found), so tests cannot run until bootstrap installs deps; mitigated by `scripts/install_martin.ps1` and `scripts/run_tests.ps1`.
- 2025-12-30: `scripts/install_martin.ps1` timed out during pip install on this machine; mitigated with `-SkipDeps` and verification doc guidance.
- 2025-12-30: `scripts/run_tests.ps1` timed out during pip install/pytest; mitigated with `-SkipInstall` and verification doc guidance.
- 2025-12-30: `pytest` not on PATH in shell; use `python -m pytest -q` (tests pass).
- 2025-12-30: Behavior debugging is weak because `logs/martin.log` only stores `chat_input len` with no sanitized summaries or assistant decisions; fixed via verbose sanitized summaries and decision logging.
- 2025-12-30: Local-only sessions still emit `cloud_call_start` and `cloud_call_fail_no_config` events in the ledger, causing noisy backoff cycles; fixed by short-circuiting cloud calls in Librarian when local-only.
- 2025-12-30: Librarian notifications blocked by local-only are logged in the ledger but not surfaced clearly in chat UX; added a concise notice when such notes arrive.
- 2025-12-30: Footer banner renders twice after responses because `_render_footer()` is called twice in chat; causes duplicate status output.
- 2025-12-30: UAT socket harness auto-wait can hang because prompt detection does not normalize ANSI prompts; needs prompt token normalization or explicit prompt events.
- 2025-12-30: UAT socket harness duplicates output in socket mode (stdout + socket stream), which can cause repeated content and false prompt matches.
- 2025-12-30: Test socket input can deadlock if MARTIN_TEST_SOCKET is enabled but the harness fails to connect; CLI blocks on socket queue.
- 2025-12-30: Test socket has no auth token/handshake and allows any local client to inject input; should be gated or locked to loopback-only.
- 2025-12-30: UAT socket harness timed out in practice because prompts are ANSI-colored and not emitted as explicit socket events; auto-wait never detects readiness.
- 2025-12-30: Socket harness has no readiness banner or "prompt ready" event, so it cannot reliably know when the CLI expects input.
- 2025-12-30: Test socket input messages are not consumed by the CLI; harness sends inputs but no input_ack or state advance is observed, leaving the CLI blocked at prompts.
- 2025-12-30: Footer banner rendered twice after responses; removed duplicate render call in chat flow.
- 2025-12-30: CLI crashed in socket UAT because `get_system_context` was referenced without import; added top-level import.
- 2025-12-30: Socket UAT can time out if context/resume delays input consumption; harness now waits on input_used with configurable timeout.
- 2025-12-30: Socket UAT needs async mailbox mode; blocking waits make it hard to test like a user. Added mailbox logging support.
- 2025-12-29: Windows cmd_template parsing kept quotes in argv, causing FileNotFoundError; stripped wrapped quotes in parser.
- 2025-12-29: TUI preflight f-string syntax error in `researcher/tui_shell.py` caused pytest collection failure; fixed.
- 2025-12-19: Agent lacks conversational context retention, gets sidetracked easily, and provides unhelpful responses due to apparent lack of understanding. Mitigated by goal thread persistence, follow-up resolver, and active context block.
- 2025-12-18: Sanitization regexes not redacting email/path; fixed patterns for emails and Windows paths in `researcher/sanitize.py`.
- 2025-12-18: Tests failed initially due to missing pytest install; added `requirements.txt` and installed dependencies.
- 2025-12-18: Pydantic regex deprecated; switched to `pattern` in `schemas.py`. Added ingestion/chunking path and logging stub; pytest suite now green.
- 2025-12-18: Expanded CLI ingestion/logging/provenance; added supervisor stub and rotating logs; tests extended for ingest pipeline (7 passing).
- 2025-12-18: FAISS/embedding load failed for private HF model (`bge-small-en-v1.5`); default embedding changed to public `all-MiniLM-L6-v2`, added fallback to SimpleIndex, and separate mock index path to avoid format conflicts.
